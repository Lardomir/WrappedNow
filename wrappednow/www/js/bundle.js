function g(e){let t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}async function u(e){let t=new TextEncoder().encode(e),n=await window.crypto.subtle.digest("SHA-256",t);return window.btoa(String.fromCharCode.apply(null,[...new Uint8Array(n)])).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}var a={clientId:"d9ba24940baa404fb039c92774ed2dda",redirectUri:"ch.example.wrappednow://callback",scope:"user-read-private user-read-email user-top-read user-read-recently-played"};async function h(){let e=g(128),t=await u(e);window.localStorage.setItem("spotify_code_verifier",e);let o=`https://accounts.spotify.com/authorize?${new URLSearchParams({response_type:"code",client_id:a.clientId,scope:a.scope,redirect_uri:a.redirectUri,code_challenge_method:"S256",code_challenge:t})}`;cordova.plugins&&cordova.plugins.browsertab?cordova.plugins.browsertab.openUrl(o):alert("BrowserTab-Plugin nicht gefunden!")}window.handleOpenURL=async e=>{console.log("Received redirect URL: "+e),cordova.plugins&&cordova.plugins.browsertab&&cordova.plugins.browsertab.close();let t=new URL(e).searchParams.get("code");if(t)await w(t);else{let n=new URL(e).searchParams.get("error");console.error("Spotify login failed:",n),alert("Login failed: "+n)}};async function w(e){let t=window.localStorage.getItem("spotify_code_verifier");if(!t){console.error("Code verifier not found!");return}let n=new URLSearchParams({client_id:a.clientId,grant_type:"authorization_code",code:e,redirect_uri:a.redirectUri,code_verifier:t});try{let o=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n.toString()});if(!o.ok){let i=await o.text();throw new Error(`HTTP status ${o.status}: ${i}`)}let s=await o.json();window.localStorage.setItem("spotify_access_token",s.access_token),window.localStorage.setItem("spotify_refresh_token",s.refresh_token),console.log("Access Token received and stored."),window.location.href="dashboard.html"}catch(o){console.error("Error getting access token:",o),alert("Error getting access token. See console for details.")}}async function y(){let e=window.localStorage.getItem("spotify_access_token");if(!e)return;let t={Authorization:`Bearer ${e}`};try{let o=await(await fetch("https://api.spotify.com/v1/me",{headers:t})).json(),s=document.getElementById("user-name");s&&o.display_name&&(s.textContent=o.display_name);let i=document.getElementById("profile-image");i&&o.images&&o.images.length>0&&(i.src=o.images[0].url);let c=await(await fetch("https://api.spotify.com/v1/me/top/tracks?limit=1",{headers:t})).json();if(c.items&&c.items.length>0){let r=document.getElementById("top-song");r&&(r.textContent=c.items[0].name)}let d=await(await fetch("https://api.spotify.com/v1/me/top/artists?limit=1",{headers:t})).json();if(d.items&&d.items.length>0){let r=document.getElementById("top-artist");r&&(r.textContent=d.items[0].name)}let l=await(await fetch("https://api.spotify.com/v1/me/player/recently-played?limit=50",{headers:t})).json();if(l.items){let r=Math.round(l.items.reduce((m,f)=>m+f.track.duration_ms,0)/6e4),p=document.getElementById("minutes-listened");p&&(p.textContent=String(r))}}catch(n){console.error("Error loading dashboard:",n)}}function _(){let e=document.getElementById("loginButton");e&&(e.style.display="block",e.addEventListener("click",h)),document.getElementById("dashboard")&&y()}document.addEventListener("deviceready",_);
